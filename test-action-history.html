<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Teste Action History</title>
    <script src="https://cdn.tailwindcss.com"></script>
  </head>
  <body class="bg-gray-50 p-4">
    <div class="max-w-4xl mx-auto">
      <h1 class="text-2xl font-bold mb-4">Teste Action History</h1>

      <div class="mb-4">
        <label class="block mb-2">Token (simulado):</label>
        <input
          type="text"
          id="test-token"
          class="border p-2 w-full"
          placeholder="Insira um token de teste"
        />
      </div>

      <button id="test-btn" class="bg-blue-500 text-white px-4 py-2 rounded">
        Testar Action History
      </button>

      <div id="action-history" class="mt-6 grid gap-4"></div>

      <div id="debug-info" class="mt-6 bg-gray-100 p-4 rounded">
        <h3 class="font-bold">Debug Info:</h3>
        <div id="debug-content"></div>
      </div>
    </div>

    <script>
      const API_URL = "http://localhost:3000";

      async function testActionHistory() {
        const token =
          document.getElementById("test-token").value || "fake-token";
        const container = document.getElementById("action-history");
        const debugContainer = document.getElementById("debug-content");

        debugContainer.innerHTML = "Iniciando teste...<br>";

        try {
          debugContainer.innerHTML +=
            "Fazendo requisiÃ§Ã£o para /usuarios/me<br>";

          const userResponse = await fetch(`${API_URL}/usuarios/me`, {
            headers: { Authorization: `Bearer ${token}` },
          });

          debugContainer.innerHTML += `Status da resposta: ${userResponse.status}<br>`;

          if (!userResponse.ok) {
            debugContainer.innerHTML += `Erro na requisiÃ§Ã£o: ${userResponse.status}<br>`;
            throw new Error("Erro ao carregar dados do usuÃ¡rio");
          }

          const userData = await userResponse.json();
          debugContainer.innerHTML += `Dados do usuÃ¡rio: ${JSON.stringify(
            userData,
            null,
            2
          )}<br>`;

          const actionHistory = userData.actionHistory || [];
          debugContainer.innerHTML += `Action history encontrado: ${actionHistory.length} itens<br>`;

          if (actionHistory.length === 0) {
            container.innerHTML =
              '<p class="text-gray-500 text-center py-4">Nenhuma penalidade ou recompensa registrada ainda.</p>';
            return;
          }

          // Ordenar por data (mais recente primeiro)
          const sortedHistory = actionHistory.sort(
            (a, b) => new Date(b.date) - new Date(a.date)
          );

          container.innerHTML = sortedHistory
            .map(
              (action) => `
                    <div class="border p-4 rounded-lg ${
                      action.type === "penalty"
                        ? "border-orange-200 bg-orange-50"
                        : "border-green-200 bg-green-50"
                    }">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2 mb-2">
                                    <span class="font-medium ${
                                      action.type === "penalty"
                                        ? "text-orange-700"
                                        : "text-green-700"
                                    }">
                                        ${
                                          action.type === "penalty"
                                            ? "ðŸš« Penalidade"
                                            : "ðŸŽ‰ Recompensa"
                                        }
                                    </span>
                                    <span class="px-2 py-1 rounded text-xs font-bold ${
                                      action.type === "penalty"
                                        ? "bg-orange-200 text-orange-800"
                                        : "bg-green-200 text-green-800"
                                    }">
                                        ${
                                          action.type === "penalty" ? "-" : "+"
                                        }${action.amount} XP
                                    </span>
                                </div>
                                <p class="text-sm text-gray-700 mb-2">${
                                  action.reason
                                }</p>
                                <div class="flex justify-between items-center text-xs text-gray-500">
                                    <span>XP: ${action.oldXP} â†’ ${
                action.newXP
              }</span>
                                    <span>${new Date(
                                      action.date
                                    ).toLocaleDateString("pt-BR", {
                                      year: "numeric",
                                      month: "2-digit",
                                      day: "2-digit",
                                      hour: "2-digit",
                                      minute: "2-digit",
                                    })}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `
            )
            .join("");

          debugContainer.innerHTML += "HistÃ³rico renderizado com sucesso!<br>";
        } catch (error) {
          debugContainer.innerHTML += `Erro: ${error.message}<br>`;
          container.innerHTML =
            '<p class="text-red-500 text-center py-4">Erro ao carregar histÃ³rico de aÃ§Ãµes</p>';
        }
      }

      document
        .getElementById("test-btn")
        .addEventListener("click", testActionHistory);
    </script>
  </body>
</html>
