<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema RPG de Aprendizado</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 font-sans">
  <div id="app" class="container mx-auto p-4">
    <!-- Tela de Login -->
    <div id="login-screen" class="max-w-md mx-auto bg-white p-6 rounded-lg shadow-md">
      <h1 class="text-2xl font-bold mb-4 text-center">Sistema RPG de Aprendizado</h1>
      <input id="username" type="text" placeholder="Nome de usuário" class="w-full p-2 mb-4 border rounded">
      <input id="password" type="password" placeholder="Senha" class="w-full p-2 mb-4 border rounded">
      <select id="class-select" class="w-full p-2 mb-4 border rounded">
        <option value="">Escolha sua classe</option>
        <option value="Arqueiro do JavaScript">Arqueiro do JavaScript</option>
        <option value="Cafeicultor do Java">Cafeicultor do Java</option>
<option value="Hunter de bugs">Hunter de bugs</option>
        <option value="Mago do CSS">Mago do CSS</option>
        <option value="Paladino do HTML">Paladino do HTML</option>
        <option value="Bárbaro do Back-end">Bárbaro do Back-end</option>
        <option value="Domador de Dados">Domador de Dados</option>
        <option value="Elfo do Front-end">Elfo do Front-end</option>
      </select>
      <button onclick="register()" class="w-full bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Cadastrar</button>
      <button onclick="login()" class="w-full bg-green-500 text-white p-2 rounded mt-2 hover:bg-green-600">Entrar</button>
    </div>

    <!-- Tela do Aluno -->
    <div id="student-screen" class="hidden max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md">
      <h1 class="text-2xl font-bold mb-4">Bem-vindo, <span id="student-name"></span>!</h1>
      <p>Classe: <span id="student-class"></span></p>
      <p>Nível: <span id="student-level"></span> | XP: <span id="student-xp"></span></p>
      <h2 class="text-xl font-bold mt-4">Missões Disponíveis</h2>
      <div id="missions" class="grid gap-4 mt-4"></div>
      <h2 class="text-xl font-bold mt-4">Submeter Código</h2>
      <select id="mission-select" class="w-full p-2 mb-4 border rounded"></select>
      <input id="code-upload" type="file" multiple class="w-full p-2 mb-4">
      <button onclick="submitCode()" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Enviar Código</button>
    </div>


    <!-- Tela do Mestre -->
    <div id="master-screen" class="hidden max-w-4xl mx-auto bg-white p-6 rounded-lg shadow-md">
      <h1 class="text-2xl font-bold mb-4">Painel do Mestre Fullstack</h1>
      <h2 class="text-xl font-bold mt-4">Usuários Pendentes</h2>
      <div id="pending-users" class="grid gap-4 mt-4"></div>
      <h2 class="text-xl font-bold mt-4">Gerenciar Alunos</h2>
      <div id="students-list" class="grid gap-4 mt-4"></div>
      <h2 class="text-xl font-bold mt-4">Submissões</h2>
      <div id="submissions-list" class="grid gap-4 mt-4"></div>
      <h2 class="text-xl font-bold mt-4">Criar Missão</h2>
      <input id="mission-title" type="text" placeholder="Título da missão" class="w-full p-2 mb-4 border rounded">
      <textarea id="mission-description" placeholder="Descrição da missão" class="w-full p-2 mb-4 border rounded"></textarea>
      <input id="mission-xp" type="number" placeholder="XP da missão" class="w-full p-2 mb-4 border rounded">
      <button onclick="createMission()" class="bg-blue-500 text-white p-2 rounded hover:bg-blue-600">Criar Missão</button>
    </div>
  </div>


  <script>
    const apiUrl = 'http://localhost:3000';


    async function register() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      const className = document.getElementById('class-select').value;
      if (!username || !password || !className) {
        alert('Preencha todos os campos!');
        return;
      }
      try {
        const response = await fetch(`${apiUrl}/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password, class: className, isMaster: false })
        });
        const data = await response.json();
        if (data.error) alert(data.error);
        else alert('Cadastro enviado! Aguardando aprovação do mestre.');
      } catch (error) {
        console.error('Erro ao conectar ao servidor:', error);
        alert('Não foi possível conectar ao servidor. Verifique se ele está rodando.');
      }
    }


    async function login() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      try {
        const response = await fetch(`${apiUrl}/login`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });
        const data = await response.json();
        if (data.error) {
          alert(data.error);
          return;
        }
        localStorage.setItem('user', JSON.stringify(data.user));
        if (data.user.isMaster) {
          showMasterScreen();
        } else {
          showStudentScreen();
        }
      } catch (error) {
        console.error('Erro ao conectar ao servidor:', error);
        alert('Não foi possível conectar ao servidor. Verifique se ele está rodando.');
      }
    }


    async function showStudentScreen() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('student-screen').classList.remove('hidden');
      const user = JSON.parse(localStorage.getItem('user'));
      document.getElementById('student-name').textContent = user.username;
      document.getElementById('student-class').textContent = user.class;
      document.getElementById('student-level').textContent = user.level;
      document.getElementById('student-xp').textContent = user.xp;


      try {
        const missionsResponse = await fetch(`${apiUrl}/missions`);
        const missions = await missionsResponse.json();
        const missionList = document.getElementById('missions');
        const missionSelect = document.getElementById('mission-select');
        missionList.innerHTML = '';
        missionSelect.innerHTML = '<option value="">Selecione uma missão</option>';
        missions.forEach(mission => {
          missionList.innerHTML += `
            <div class="p-4 bg-gray-100 rounded">
              <h3 class="font-bold">${mission.title}</h3>
              <p>${mission.description}</p>
              <p>XP: ${mission.xp}</p>
            </div>`;
          missionSelect.innerHTML += `<option value="${mission.id}">${mission.title}</option>`;
        });
      } catch (error) {
        console.error('Erro ao carregar missões:', error);
        alert('Erro ao carregar missões.');
      }
    }


    async function submitCode() {
      const user = JSON.parse(localStorage.getItem('user'));
      const missionId = document.getElementById('mission-select').value;
      const fileInput = document.getElementById('code-upload');
      if (!missionId || !fileInput.files.length) {
        alert('Selecione uma missão e pelo menos um arquivo!');
        return;
      }
      const formData = new FormData();
      for (const file of fileInput.files) {
        formData.append('code', file);
      }
      formData.append('missionId', missionId);
      formData.append('userId', user.id);
      try {
        const response = await fetch(`${apiUrl}/submit`, {
          method: 'POST',
          body: formData
        });
        const data = await response.json();
        if (data.error) alert(data.error);
        else {
          alert('Submissão enviada! Aguardando aprovação do mestre.');
          showStudentScreen();
        }
      } catch (error) {
        console.error('Erro ao enviar código:', error);
        alert('Erro ao enviar código.');
      }
    }


    async function showMasterScreen() {
      document.getElementById('login-screen').classList.add('hidden');
      document.getElementById('master-screen').classList.remove('hidden');
      try {
        // Carregar usuários pendentes
        const pendingResponse = await fetch(`${apiUrl}/pending-users`);
        const pendingUsers = await pendingResponse.json();
        const pendingList = document.getElementById('pending-users');
        pendingList.innerHTML = '';
        pendingUsers.forEach(user => {
          pendingList.innerHTML += `
            <div class="p-4 bg-yellow-100 rounded">
              <p><strong>${user.username}</strong> (${user.class})</p>
              <button onclick="approveUser('${user.id}')" class="bg-green-500 text-white p-2 rounded hover:bg-green-600">Aprovar</button>
              <button onclick="rejectUser('${user.id}')" class="bg-red-500 text-white p-2 rounded hover:bg-red-600">Rejeitar</button>
            </div>`;
        });


        // Carregar alunos aprovados
        const studentsResponse = await fetch(`${apiUrl}/students`);
        const students = await studentsResponse.json();
        const studentList = document.getElementById('students-list');
        studentList.innerHTML = '';
        students.forEach(student => {
          studentList.innerHTML += `
            <div class="p-4 bg-gray-100 rounded">
              <p><strong>${student.username}</strong> (${student.class})</p>
              <p>Nível: ${student.level} | XP: ${student.xp}</p>
              <input type="number" id="penalty-${student.id}" placeholder="Penalidade de XP" class="p-2 border rounded">
              <button onclick="applyPenalty('${student.id}')" class="bg-red-500 text-white p-2 rounded hover:bg-red-600">Aplicar Penalidade</button>
            </div>`;
        });


        // Carregar submissões
        const submissionsResponse = await fetch(`${apiUrl}/submissions`);
        const submissions = await submissionsResponse.json();
        const submissionsList = document.getElementById('submissions-list');
        submissionsList.innerHTML = '';
        submissions.forEach(sub => {
          const filesHtml = sub.filePaths.map(filePath => `
            <a href="${filePath.replace(__dirname, '')}" target="_blank" class="text-blue-500 underline">Baixar ${filePath.split('/').pop()}</a>
          `).join('<br>');
          submissionsList.innerHTML += `
            <div class="p-4 bg-blue-100 rounded">
              <p><strong>Usuário:</strong> ${sub.username}</p>
              <p><strong>Missão:</strong> ${sub.missionTitle}</p>
              <p><strong>Enviado em:</strong> ${new Date(sub.submittedAt).toLocaleString()}</p>
              <p><strong>Status:</strong> ${sub.pending ? 'Pendente' : 'Aprovado'}</p>
              <p><strong>Arquivos:</strong><br>${filesHtml}</p>
              ${sub.pending ? `
                <button onclick="approveSubmission('${sub.id}')" class="bg-green-500 text-white p-2 rounded hover:bg-green-600">Aprovar Submissão</button>
                <button onclick="rejectSubmission('${sub.id}')" class="bg-red-500 text-white p-2 rounded hover:bg-red-600">Rejeitar Submissão</button>
              ` : ''}
            </div>`;
        });
      } catch (error) {
        console.error('Erro ao carregar dados do mestre:', error);
        alert('Erro ao carregar dados do mestre.');
      }
    }


    async function approveUser(userId) {
      try {
        const response = await fetch(`${apiUrl}/approve-user`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId })
        });
        const data = await response.json();
        if (data.error) alert(data.error);
        else {
          alert('Usuário aprovado!');
          showMasterScreen();
        }
      } catch (error) {
        console.error('Erro ao aprovar usuário:', error);
        alert('Erro ao aprovar usuário.');
      }
    }


    async function rejectUser(userId) {
      try {
        const response = await fetch(`${apiUrl}/reject-user`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ userId })
        });
        const data = await response.json();
        if (data.error) alert(data.error);
        else {
          alert('Usuário rejeitado!');
          showMasterScreen();
        }
      } catch (error) {
        console.error('Erro ao rejeitar usuário:', error);
        alert('Erro ao rejeitar usuário.');
      }
    }


    async function approveSubmission(submissionId) {
      try {
        const response = await fetch(`${apiUrl}/approve-submission`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ submissionId })
        });
        const data = await response.json();
        if (data.error) alert(data.error);
        else {
          alert('Submissão aprovada! XP atribuído.');
          showMasterScreen();
        }
      } catch (error) {
        console.error('Erro ao aprovar submissão:', error);
        alert('Erro ao aprovar submissão.');
      }
    }


    async function rejectSubmission(submissionId) {
      try {
        const response = await fetch(`${apiUrl}/reject-submission`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ submissionId })
        });
        const data = await response.json();
        if (data.error) alert(data.error);
        else {
          alert('Submissão rejeitada!');
          showMasterScreen();
        }
      } catch (error) {
        console.error('Erro ao rejeitar submissão:', error);
        alert('Erro ao rejeitar submissão.');
      }
    }


    async function applyPenalty(studentId) {
      const penalty = document.getElementById(`penalty-${studentId}`).value;
      if (!penalty) {
        alert('Digite uma penalidade!');
        return;
      }
      try {
        const response = await fetch(`${apiUrl}/penalty`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ studentId, penalty: parseInt(penalty) })
        });
        const data = await response.json();
        if (data.error) alert(data.error);
        else {
          alert('Penalidade aplicada!');
          showMasterScreen();
        }
      } catch (error) {
        console.error('Erro ao aplicar penalidade:', error);
        alert('Erro ao aplicar penalidade.');
      }
    }


    async function createMission() {
      const title = document.getElementById('mission-title').value;
      const description = document.getElementById('mission-description').value;
      const xp = document.getElementById('mission-xp').value;
      if (!title || !description || !xp) {
        alert('Preencha todos os campos!');
        return;
      }
      try {
        const response = await fetch(`${apiUrl}/missions`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title, description, xp: parseInt(xp) })
        });
        const data = await response.json();
        if (data.error) alert(data.error);
        else {
          alert('Missão criada!');
          document.getElementById('mission-title').value = '';
          document.getElementById('mission-description').value = '';
          document.getElementById('mission-xp').value = '';
        }
      } catch (error) {
        console.error('Erro ao criar missão:', error);
        alert('Erro ao criar missão.');
      }
    }
  </script>
</body>
</html>

